@page "/debt"
@using System.Text.Json
@using System.Linq

<h1>Debts</h1>
<NavLink href="/transaction"><button>←</button></NavLink> @* navigate to the transaction page *@

<h2>Add Debt</h2>

<EditForm Model="debt" OnValidSubmit="AddDebt">
    <div class="form-group">
        <label for="amount">Debt Amount:</label>
        <InputNumber @bind-Value="debt.DebtAmount" id="amount" />
    </div>
    <div class="form-group">
        <label for="date">Date of Debt:</label>
        <InputDate @bind-Value="debt.DoD" id="date" />
    </div>
    <div class="form-group">
        <label for="creditor">Creditor:</label>
        <InputText @bind-Value="debt.Creditor" id="creditor" />
    </div>
    <div class="form-group">
        <label for="interestRate">Interest Rate (optional):</label>
        <InputNumber @bind-Value="debt.InterestRate" id="interestRate" />
    </div>
    <div class="form-group">
        <label for="dueDate">Due Date:</label>
        <InputDate @bind-Value="debt.DueDate" id="dueDate" />
    </div>
    <div class="form-group">
        <label for="note">Note:</label>
        <InputText @bind-Value="debt.Note" id="note" />
    </div>
    <button type="submit" class="btn btn-primary">Add Debt</button>
</EditForm>

@if (debts != null && debts.Count > 0) @* code to display the debt history *@
{
    <h3>Pending debts</h3>
    <table>
        <thead>
            <tr>
                <th>Debt Amount</th>
                <th>Date of Debt</th>
                <th>Creditor</th>
                <th>Interest Rate</th>
                <th>Due Date</th>
                <th>Note</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var debt in debts)
            {
                <tr>
                    <td>@debt.DebtAmount</td>
                    <td>@debt.DoD.ToString("yyyy-mm-dd")</td>
                    <td>@debt.Creditor</td>
                    <td>@debt.InterestRate.ToString("P")</td>
                    <td>@debt.DueDate.ToString("yyyy-mm-dd")</td>
                    <td>@debt.Note</td>
                    <td>
                        <button class="btn btn-payoff" style="background-color: #263845; color: white;" @onclick="() => ClearDebt(debt)">Pay Off</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    //object to hold the current debt being added
    private Debts debt = new Debts();

    //list to store all debts loaded from or saved to the file
    private List<Debts> debts = new List<Debts>();

    //method to add a new debt to the list and save to the file
    private void AddDebt()
    {
        debts.Add(debt);
        debt = new Debts(); // Clear the form fields after adding
        SaveDebtsToFile();
    }

    //method to remove a debt from the list and save the changes to the file
    private void ClearDebt(Debts debtToClear)
    {
        debts.Remove(debtToClear);
        SaveDebtsToFile();
    }

    //method to save the list of debts to the JSON file
    private void SaveDebtsToFile()
    {
        var path = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "debts.json");
        var json = JsonSerializer.Serialize(debts);
        File.WriteAllText(path, json);
    }

    //load debts from the JSON file on component initialization
    protected override void OnInitialized()
    {
        var path = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "debts.json");
        if (File.Exists(path))
        {
            var json = File.ReadAllText(path);
            debts = JsonSerializer.Deserialize<List<Debts>>(json) ?? new List<Debts>();
        }
    }

    public class Debts
    {
        public int DebtAmount { get; set; }
        public DateTime DoD { get; set; }
        public string Creditor { get; set; }
        public decimal InterestRate { get; set; }
        public DateTime DueDate { get; set; }
        public string Note { get; set; }
    }
}